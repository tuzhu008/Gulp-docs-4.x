<!-- front-matter
id: watch
title: watch()
hide_title: true
sidebar_label: watch()
-->

# watch()

监听 globs 并在发生更改时运行任务。任务与任务系统的其余部分被统一处理。

## 用法

```js
const { watch } = require('gulp');

watch(['input/*.js', '!input/something.js'], function(cb) {
  // body omitted
  cb();
});
```

## 签名

```js
watch(globs, [options], [task])
```

### 参数

| 参数 | 类型 | 描述 |
|:--------------:|:-----:|--------|
| globs<br>**(required)** | string<br>array | [Globs][globs-concepts] 用来监听文件系统。 |
| options | object | 详情参见下文 [选项][options-section] |
| task | function<br>string | 一个 [任务函数][tasks-concepts] 或由 `series()` 和 `parallel()` 生成的组合任务 |

### 返回值

[chokidar][chokidar-instance-section] 的一个实例，用于对监听设置进行细粒度控制。

### Errors

当以 `globs` 形式传递非字符串或带有任何非字符串的数组时，将抛出一个错误，并提示 "Non-string provided as watch path"。

当字符串或数组作为 `task` 传递时，会抛出一个错误，提示 "watch task has to be a function (optionally generated by using gulp.parallel or gulp.series)"（ watch 任务必须是一个函数(可以选择使用 gulp.parallel 或 gulp.series 生成))。

### 选项

| 名称 | 类型 | 默认值 | 描述 |
|:-------:|:------:|-----------|--------|
| ignoreInitial | boolean | true | false，则在实例化过程中调用该任务，以发现文件路径。用于在启动期间触发任务。<br>**注意:** 这个选项被传递给 [chokidar][chokidar-external]，但默认为 `true` 而不是 `false`。|
| delay | number | 200 | 文件更改和任务执行之间的毫秒延迟。允许在执行任务之前等待许多更改，例如查找和替换许多文件。|
| queue | boolean | true | 当为 true 且任务已经运行时，任何文件更改都将对单个任务执行进行排队。避免长时间运行的任务重叠。 |
| events | string<br>array | [ 'add',<br>'change',<br>'unlink' ] |  正在监听的事件，以触发任务执行。可以是 `'add'`、`'addDir'`、`'change'`、`'unlink'`、`'unlinkDir'`, `'ready'`、和/或 `'error'`。 另外 `'all'` 也是可用的，它表示除 `'ready'` 和 `'error'` 之外的所有事件。<br>_此选项被直接传递给 [chokidar][chokidar-external]._ |
| persistent | boolean | true | 如果为 false，监听器将不会保持 Node 进程的运行。不建议禁用此选项。<br>_此选项被直接传递给 [chokidar][chokidar-external]._ |
| ignored | array<br>string<br>RegExp<br>function |  | Defines globs to be ignored. If a function is provided, it will be called twice per path - once with just the path, then with the path and the `fs.Stats` object of that file.<br>_此选项被直接传递给 [chokidar][chokidar-external]._ |
| followSymlinks | boolean | true | 如果为 true，对符号链接和链接的文件的更改都将触发事件。如果为 false，则只有对符号链接的更改才触发事件。<br>_此选项被直接传递给 [chokidar][chokidar-external]._ |
| cwd | string |  | 将与任何相对路径相结合以形成绝对路径的目录。对于绝对路径忽略。用于避免将 `globs` 与 `path.join()` 组合使用。<br>_此选项被直接传递给 [chokidar][chokidar-external]._ |
| disableGlobbing | boolean | false | 如果为 true，所有 `globs` 都被视为字面路径名称，即使它们具有特殊字符。<br>_此选项被直接传递给 [chokidar][chokidar-external]._ |
| usePolling | boolean | false | 当为 false 时，监听器将使用 `fs.watch()`（或 Mac 上的 [fsevents][fsevents-external]）(或[fsevents][fsevents-external])进行监听。如果为 true，则使用 `fs.watchFile()` 轮询代替——这是通过网络或其他非标准情况成功监听文件所必需的。覆盖 `useFsEvents` 默认值。<br>_此选项被直接传递给 [chokidar][chokidar-external]._|
| interval | number | 100 | Combine with `usePolling: true`. Interval of file system polling.<br>_此选项被直接传递给 [chokidar][chokidar-external]._ |
| binaryInterval | number | 300 | Combine with `usePolling: true`. Interval of file system polling for binary files.<br>_此选项被直接传递给 [chokidar][chokidar-external]._ |
| useFsEvents | boolean | true | When true, uses fsevents for watching if available. If explicitly set to true, supersedes the `usePolling` option. If set to false, automatically sets `usePolling` to true.<br>_此选项被直接传递给 [chokidar][chokidar-external]._ |
| alwaysStat | boolean | false | If true, always calls `fs.stat()` on changed files - will slow down file watcher. The `fs.Stat` object is only available if you are using the chokidar instance directly.<br>_此选项被直接传递给 [chokidar][chokidar-external]._ |
| depth | number |  | Indicates how many nested levels of directories will be watched.<br>_此选项被直接传递给 [chokidar][chokidar-external]._ |
| awaitWriteFinish | boolean | false | Do not use this option, use `delay` instead.<br>_此选项被直接传递给 [chokidar][chokidar-external]._ |
| ignorePermissionErrors | boolean | false | Set to true to watch files that don't have read permissions. Then, if watching fails due to EPERM or EACCES errors, they will be skipped silently.<br>_此选项被直接传递给 [chokidar][chokidar-external]._ |
| atomic | number | 100 | Only active if `useFsEvents` and `usePolling` are false. Automatically filters out artifacts that occur from "atomic writes" by some editors. If a file is re-added within the specified milliseconds of being deleted, a change event - instead of unlink then add - will be emitted.<br>_此选项被直接传递给 [chokidar][chokidar-external]._ |

## Chokidar 实例

The `watch()` method returns the underlying instance of [chokidar][chokidar-external], providing fine-grained control over your watch setup. Most commonly used to register individual event handlers that provide the `path` or `stats` of the changed files.

**When using the chokidar instance directly, you will not have access to the task system integrations, including async completion, queueing, and delay.**

```js
const { watch } = require('gulp');

const watcher = watch(['input/*.js']);

watcher.on('change', function(path, stats) {
  console.log(`File ${path} was changed`);
});

watcher.on('add', function(path, stats) {
  console.log(`File ${path} was added`);
});

watcher.on('unlink', function(path, stats) {
  console.log(`File ${path} was removed`);
});

watcher.close();
```


`watcher.on(eventName, eventHandler)`

Registers `eventHandler` functions to be called when the specified event occurs.

| parameter | type | note |
|:--------------:|:-----:|--------|
| eventName | string | The events that may be watched are `'add'`, `'addDir'`, `'change'`, `'unlink'`, `'unlinkDir'`, `'ready'`, `'error'`, or `'all'`. |
| eventHandler | function | Function to be called when the specified event occurs. Arguments detailed in the table below. |

| argument | type | note |
|:-------------:|:-----:|--------|
| path | string | The path of the file that changed. If the `cwd` option was set, the path will be made relative by removing the `cwd`. |
| stats | object | An [fs.Stat][fs-stats-concepts] object, but could be `undefined`. If the `alwaysStat` option was set to `true`, `stats` will always be provided. |

`watcher.close()`

Shuts down the file watcher. Once shut down, no more events will be emitted.

`watcher.add(globs)`

Adds additional globs to an already-running watcher instance.

| parameter | type | note |
|:-------------:|:-----:|--------|
| globs | string<br>array | The additional globs to be watched. |

`watcher.unwatch(globs)`

Removes globs that are being watched, while the watcher continues with the remaining paths.

| parameter | type | note |
|:-------------:|:-----:|--------|
| globs | string<br>array | The globs to be removed. |

[chokidar-instance-section]: #chokidar-instance
[options-section]: #options
[tasks-concepts]: ../api/concepts.md#tasks
[globs-concepts]: ../api/concepts.md#globs
[fs-stats-concepts]: ../api/concepts.md#file-system-stats
[chokidar-external]: https://github.com/paulmillr/chokidar
[fsevents-external]: https://github.com/strongloop/fsevents
